<!DOCTYPE HTML>
<html>

<head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible" />
    <script type="text/javascript" src="static/js/jquery-1.4.2.min.js"></script>
	<script src="static/js/webix/codebase/webix.js" type="text/javascript"></script>
    <link rel="stylesheet" href="static/js/webix/codebase/webix.css" type="text/css">
    <link rel="stylesheet" href="static/css/balloo.css" type="text/css">
    <script type="text/javascript" src="static/js/socket.io.min.js"></script>
    <link rel="shortcut icon" href="static/img/wings.ico">
</head>

<body>


	<div id="panel_dataitems" style='display:none;'>
        <div class="webix_icon icon fa-cloud-download"></div>
        <div class="details">
            <div class="value" id="value_dataitems">-</div>
            <div class="text">data messages</div>
        </div>
        <div class="footer">View more <span class="webix_icon fa-angle-double-right"></span></div>
	</div>

	<div id="panel_lastmessage" style='display:none;'>
        <div class="webix_icon icon fa-clock-o"></div>
        <div class="details">
            <div class="value" id="value_lastmsg">-</div>
            <div class="text">last message</div>
        </div>
        <div class="footer">View more <span class="webix_icon fa-angle-double-right"></span></div>
	</div>

	<div id="panel_altitude" style='display:none;'>
        <div class="webix_icon icon fa-line-chart"></div>
        <div class="details">
            <div class="value">12'458 m</div>
            <div class="text">altitude</div>
        </div>
        <div class="footer">View more <span class="webix_icon fa-angle-double-right"></span></div>
	</div>

	<div id="panel_increasing" style='display:none;'>
        <div class="webix_icon icon fa-fighter-jet"></div>
        <div class="details">
            <div class="value">5 m/s</div>
            <div class="text">increasing</div>
        </div>
        <div class="footer">View more <span class="webix_icon fa-angle-double-right"></span></div>
	</div>

    <div id="titlecontainer" style='display:none;'>
       <!--<div class="titletext">balloo - realtime web service</div>-->
        <img src="static/img/logo_invert_weiss.png" height="35px" style="padding-left:20px"/>
    </div>

    <div id="boximages" class="boximages" style='display:none;'>
       <div class="boxheader">images</div>
        body text
    </div>

    <div id="boxctlog" class="boxctlog" style='display:none;'>
       <pre style="font-size: 11px; padding:0px; margin: 0px;" id="boxctlogtext">
       </pre>
    </div>



	<script type="text/javascript" charset="utf-8">

        var menu_data = [
            {
                id:"1",
                value:"Info",
                css:{'background-color':'rgb(95, 95, 95)'},
            }
        ];
        var menu = {
            view:"menu",
            data: menu_data,
            css:{'background-color':'rgb(95, 95, 95)'}
        };

		webix.ui({
			type: "clean",
            id: "balloodoc",
			rows: [
            {
                type:"clean",
                /*cols:[ menu ],*/
                /*css:{'background-color':'rgb(95, 95, 95)'},*/
                height: 50,
                cols: [{
                    type: "space",
                    template: "html->titlecontainer",
                    /*template: "ssss"*/
                    css:{'background-color':'rgb(95, 95, 95)'},
                },{
                    view:"toolbar",
                    cols:[
                        {
                            gravity: 4,
                        }, {
                            view:"icon",
                            icon:"database",
                            id:"action_cleanup"
                        }, {
                            view:"icon",
                            icon:"key",
                            id:"action_setnewpasswd"
                        }, {
                            view:"icon",
                            icon:"user-secret",
                            id:"action_login"
                        }
                    ]
                }]
            }, {
                type: "space",
			    rows: [
                {
                    type: "wide",
                    height: 130,
                    id: "panels",
                    cols: [{
                        css:{'background-color':'rgb(166, 147, 235)', 'box-shadow': '0 0 8px rgba(0,0,0,.2)', 'border-radius': '2px'},
                        template: "html->panel_dataitems",
                        id: "col_dataitems"
                    }, {
                        css:{'background-color':'rgb(99, 180, 234)', 'box-shadow': '0 0 8px rgba(0,0,0,.2)', 'border-radius': '2px'},
                        template: "html->panel_lastmessage",
                        id: "col_lastmessage"
                    }, {
                        css:{'background-color':'rgb(241, 155, 96)', 'box-shadow': '0 0 8px rgba(0,0,0,.2)', 'border-radius': '2px'},
                        template: "html->panel_altitude"
                    }, {
                        css:{'background-color':'rgb(73, 205, 129)', 'box-shadow': '0 0 8px rgba(0,0,0,.2)', 'border-radius': '2px'},
                        template: "html->panel_increasing"
                    }]

                },{
                    type: "wide",
                    rows: [{
                        type: "wide",
                        height: "48%",
                        id: "panels",
                        cols: [{
                            type:"clean",
                            "css": "webix_view_box",
                            rows:[
                                {
                                    "template": "<span class='webix_icon fa-file-image-o' style='padding-right: 20px'></span>last image",
                                    "css": "sub_title",
                                    "height": 40
                                },
                                {
                                    template: "<img src='/getimage' />"
                                }
                            ]
                        }, {
                            type:"clean",
                            "css": "webix_view_box",
                            rows:[
                                {
                                    "template": "<span class='webix_icon fa-map-marker' style='padding-right: 20px'></span>google map path",
                                    "css": "sub_title",
                                    "height": 40
                                },
                                {
                                    template: "html->gmapcontainer",
                                    id: "gmapview"
                                }
                            ]
                        }]
                    },{
                        type: "wide",
                        height: "52%",
                        id: "panels",
                        cols: [{
                            type:"clean",
                            "css": "webix_view_box",
                            rows:[
                                {
                                    "template": "<span class='webix_icon fa-line-chart' style='padding-right: 20px'></span>altitude / speed",
                                    "css": "sub_title",
                                    "height": 40
                                },
                                {
                                    template: "altitude / speed"
                                }
                            ]
                        }, {
                            type:"clean",
                            "css": "webix_view_box",
                            rows:[
                                {
                                    "template": "<span class='webix_icon fa-file-text-o' style='padding-right: 20px'></span>log",
                                    "css": "sub_title",
                                    "height": 40
                                },
                                {
                                    template: "html->boxctlog",
                                    id: "boxctlog",
                                    scroll: true,
                                }
                            ]
                        }]
                    }]
                }]
            }]
		});

        $$('action_cleanup').attachEvent("onItemClick", function(id,value){
            webix.confirm({
                title:"cleanup database",
                ok:"Yes",
                cancel:"No",
                text:"are you sure to cleanup <br>the <b>database</b>?<br><br>You will lose all received data!",
                callback: function(result){
                    if(result){
                        socket.emit('cleanup', {
                            'loggingtype':  'cleanup',
                            'uuid':         webix.storage.cookie.get('uuid')
                        });
                        webix.message("database is now empty");
                    }
                }
            });


        });

        $$('action_login').attachEvent("onItemClick", function(id,value){
            $$('log_form_window').show();
        });


        var socket
        var logarr = []
        $(document).ready(function(){
            $$('action_cleanup').hide();
            $$('action_setnewpasswd').hide();

            namespace = '/api'; // change to an empty string to use the global namespace
            socket = io.connect('http://' + document.domain + ':' + location.port + namespace);
            socket.emit('join', {room: 'webroom', 'uuid': webix.storage.cookie.get('uuid')});

            socket.on('dataitems', function(msg) {
                $('#value_dataitems').html(msg.msgcount);
                $$('col_dataitems').define("template","html->panel_dataitems");
                $$('col_dataitems').refresh();
                lastmsgrec = 0
            });

            socket.on('startup', function(msg) {
                console.log(msg)
                $('#value_dataitems').html(msg.msgcount);
                $$('col_dataitems').define("template","html->panel_dataitems");
                $$('col_dataitems').refresh();
                lastmsgrec = msg.lastmsg
                addsec2lastmsg()

                if(msg['auth'] == true){
                    $$('action_cleanup').show();
                    $$('action_setnewpasswd').show();
                    $$('action_login').hide();
                    auth = true
                }

                for (var i = msg['log'].length-1; i > -1; i--) {
                    addmsg2log(msg['log'][i])
                }

            });

            socket.on('log', function(msg) {
                //countlogmsg++;
                addmsg2log(msg)
            });

            socket.on('auth', function(msg) {
                webix.storage.cookie.put('uuid', msg['uuid']);
                console.log(msg)
                if(msg['auth'] == true){
                    webix.message("login successful");
                    auth = true;
                    $$('log_form_window').hide();
                    $$('action_cleanup').show();
                    $$('action_setnewpasswd').show();
                    $$('action_login').hide();
                    return
                }
                webix.message({type:"error", text:"password is invalid"});
            });

		});

        function addmsg2log(msg){
           logarr.push(msg);

            var htmltext = ""
            if(logarr.length > 100){
               logarr.splice(0, 1);
            }

            for (var i = logarr.length-1; i > -1; i--) {
                htmltext += logarr[i] + "<br>"
            }
            $('#boxctlogtext').html(htmltext)
            $$('boxctlog').define("template","html->boxctlog");
            $$('boxctlog').refresh();
        }


        function calc2min(sec){
            var minutes = Math.floor(sec / 60);
            var seconds = sec - minutes * 60;
            if(seconds < 10){
                return minutes + ":0" + seconds;
            }
            return minutes + ":" + seconds;

        }

        var lastmsgrec = 0;
        function addsec2lastmsg(){
            lastmsgrec += 1;
            $('#value_lastmsg').html(calc2min(lastmsgrec));
            $$('col_lastmessage').define("template","html->panel_lastmessage");
            $$('col_lastmessage').refresh();
        }

        setInterval(addsec2lastmsg, 1000);

        // ----------------------------------------------------------------
        // LOGIN

        webix.ui({
            view:"window",
            id:"log_form_window",
            height:250,
            width:300,
            position:"center",
            head:false,
            body:{
                view:"form",
                id:"log_form",
                width:300,
                elements:[
                    { view:"text", type:"password", label:"Password", id:"log_form_password"},
                    { margin:5, cols:[
                        { view:"button", value:"Login" , type:"form", id:"log_form_login" },
                        { view:"button", value:"Cancel", id:"log_form_cancel" }
                    ]}
                    ]
            }
        }).hide();

        auth = false
		$$('log_form_cancel').attachEvent("onItemClick", function(id,value){
           $$('log_form_window').hide();
		});

		$$('log_form_login').attachEvent("onItemClick", function(id,value){
            emitauth();
		});

        $$("log_form_password").attachEvent("onKeyPress", function(code, e) {
            if (code === 13) {
                emitauth();
            }
        });

        function emitauth(){
            socket.emit('auth', {
                password:       $$('log_form_password').getValue(),
                'loggingtype':  'auth',
                'uuid':         webix.storage.cookie.get('uuid')
            });

        }

        // ----------------------------------------------------------------
        // ---

	</script>
</body>
</html>